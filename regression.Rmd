---
title: "Regression"
author: "Frank"
date: "11/19/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(zipcode)
library(tidyverse)
library(usmap)
library(ggplot2)
library(tidytext)
library(tm)
library(topicmodels)
library(wordcloud)
library(RColorBrewer)
library(sentimentr)
library(lme4)
library(arm)
library(pROC)
library(lattice)
```

"Real Talk" is an online platform aiming for teenagers to talk about their own experiences about relationships, puberty, bullying, etc.. Teenagers post their own stories on the platform, which could be a sentence or a paragraph. Not all stories are available to the public, but my team managed to make contact to them and do some data analysis for them.

```{r}
# Reading samples
sample <- read.csv("Real_Talk_Data.csv", stringsAsFactors = FALSE)
sample <- sample[1:812,]
colnames(sample)[13] <- "zip"
sample$zip[sample$zip < 10000 & is.na(sample$zip) == F] <- 
  sprintf("%05d", sample$zip[sample$zip < 10000 & is.na(sample$zip) == F])
sample <- sample[ , colSums(!is.na(sample)) != 0]
sample$Story <- do.call(paste, c(sample[18:127], sep=" "))
sample <- sample[,c(1:17,128)]

# Category Data Cleaning up
sample$LGBTQ.[sample$LGBTQ. == "" | is.na(sample$LGBTQ.) == T] <- "Prefer not to share"
sample$LGBTQ.[sample$LGBTQ. == "nyes" | sample$LGBTQ. == "yes "] <- "yes"
sample$LGBTQ.[sample$LGBTQ. == "on"] <- "no"
sample$Gender[sample$Gender == "" | is.na(sample$Gender) == T] <- "Prefer not to share"
sample$Gender[sample$Gender == "abstain" | sample$Gender == "abstain "] <- "Prefer not to share"
sample$Gender[sample$Gender == "Female"] <- "female"
sample$Gender[sample$Gender == "Male" | sample$Gender == "male "] <- "male"
sample$Gender[sample$Gender == "Other" | sample$Gender == "non-binary" | sample$Gender == "Non-binary"] <- "other"
sample$Submission..Type[sample$Submission..Type == "squarespace"] <- "Mobile App"
sample$Submission..Type[sample$Submission..Type == "online"] <- "Website"
sample$Submission..Type[sample$Submission..Type == "peers"] <- "in person"

# Adding Sentiment score
sample$sentiment <- sentiment_by(sample$Story)[,4]
sample$sentiment <- 10*apply(sample$sentiment,2,as.numeric)

# Adding zipcode, states, count, and other predictors
data(zipcode)
zip <- zipcode %>% 
  dplyr::select(zip, state) %>% 
  distinct(zip, .keep_all = TRUE)
samplestate <- merge(sample, zip, by = "zip")
samplecount <- samplestate %>% 
  group_by(state) %>% 
  count(state)
realtalk <- merge(sample, zip, by = "zip", all.x = TRUE)
regdata <- realtalk[c(-3,-10,-11,-17,-131,-133,-272,-411,-449,-614,-622,-769,-777,-806), c(1,19,4,10:12,17:18,20)]
sentimentmean <- regdata %>% 
  group_by(state) %>% 
  summarise(mean_sent = mean(sentiment, na.rm = T))

# Adding election data
sentimentmean <- merge(sentimentmean, samplecount, by = "state")
sentimentmean$red <- 0
sentimentmean$red[c(1:3,5,7,8,10,11,13:16,19:28,33,34,36,38:42,44:46)] <- 1
```

Reading in data. 
The original data has 18 columns.

Code Book:
1. Submission..code: the code id generated for each submission.
2. Data.of..submission: the exact data for each submission.
3. Submission..Type: the platform used for each submission.
4. Location.of..Submission: the location for each submission, only applicable for part of "in person" type submissions. The capital letters stand for middle school names.
5. Score: scored by certain Real Talk employees deciding whether they should publish the data.
6. Scored.By: the certain employee that scored the story.
7. Published: the final decision on whether they will publish the story.
8. Published.Date: the date of publish, only applicable for stories that already published.
9. Gender: the gender of the user who published the story. Male/female/other/prefer not to share.
10. LGBTQ.: the LGBTQ. status of the user who published the story. Yes/no/prefer not to share.
11. Age: the age of the user who published the story.
12. Race: the race of the user who published the story.
13. zip: the zip code users submitted when signing up for the account.
14. Location: the location users submitted when signing up for the account.
15. Phone..: the phone numbers users submitted when signing up for the account.
16. Email.Address: the email address users submitted when signing up for the account.
17. Subject: the subject of the each story posted. Users had to choose one subject before submitting each stories.
18. Story: the exact text of story of the each story posted. Can be as shorted as several words, or several sentences.

```{r}
teenpreg14 <- read.csv("TEENBIRTHS2014.csv")
teenpreg15 <- read.csv("TEENBIRTHS2015.csv")
teenpreg16 <- read.csv("TEENBIRTHS2016.csv")
teenpreg <- merge(teenpreg14, teenpreg15, by = "STATE")
teenpreg <- merge(teenpreg, teenpreg16, by = "STATE")
teenpreg$rate <- rowMeans(teenpreg[,c(2,4,6)])
teenpreg <- teenpreg[,c(1,8)]
colnames(teenpreg) <- c("state", "teen_preg_rate")
```

Also including the teenager pregnancy data

```{r}
suicide <- read.table("Compressed Mortality, 1999-2016.txt", sep = "", header = T, fill = T, nrows = 50)
suicide <- suicide[,c(1,3:5)]
colnames(suicide) <- c("State", "death", "population", "suicide_rate")
for (i in 1:50){
  suicide$state[i] <- state.abb[grep(suicide[i, 1], state.name)]
}
suicide <- suicide[,c(5,4)]
```


```{r}
# Preprocessing regression data
if (!"red" %in% colnames(regdata)){
  regdata <- merge(regdata, sentimentmean[,c(1,4)], by = "state", all.x = TRUE)
}
regdata$Gender <- as.factor(regdata$Gender)
regdata$LGBTQ. <- as.factor(regdata$LGBTQ.)
regdata$state <- as.factor(regdata$state)
regdata$Submission..Type <- as.factor(regdata$Submission..Type)
regdata$Subject <- as.factor(regdata$Subject)
regdata$wordcount <- str_count(regdata$Story, '\\w+')
regdata$sentiment2 <- 0
regdata$sentiment2[regdata$sentiment > 0] <- 1

# Creating Regions
regdata$Reg[regdata$state %in% c("WA", "OR", "CA", "NV", "ID", "MT", "WY", "UT", "CO", "AK", "HI")] <- "west"
regdata$Reg[regdata$state %in% c("ND", "MN", "WI", "MI", "OH", "IN", "IL", "IA", "MO", "SD", "NE", "KS")] <- "midwest"
regdata$Reg[regdata$state %in% c("AZ", "NM", "OK", "TX")] <- "southwest"
regdata$Reg[regdata$state %in% c("AR", "LA", "MS", "AL", "GA", "FL", "SC", "NC", "KY", "TN", "WV", "VA", "MD", "DE")] <- "southeast"
regdata$Reg[regdata$state %in% c("ME", "VT", "NH", "MA", "NY", "RI", "CT", "NJ", "PA")] <- "northeast"

regdata <- merge(regdata, teenpreg, by = "state", all.x = T)
regdata <- merge(regdata, suicide, by = "state", all.x = T)

# Regdata2 is the datasets with no NA rows
regdata2 <- regdata[is.na(regdata$state) == F & is.na(regdata$Age) == F,]
```


```{r}
# Basic population visualization
plot_usmap(regions = "states", data = samplecount, values = "n", lines = "grey") + 
  scale_fill_continuous(low = "#FFCC33", high = "brown", name = "Story Population", label = scales::comma) +
  labs(title = "Real Talk Sample Density in US") + 
  theme(panel.background = element_rect(colour = "black", fill = "white"), legend.position = "right")
plot_usmap(regions = "states", data = sentimentmean, values = "mean_sent", lines = "grey") + 
  scale_fill_continuous(low = "red", high = "white", name = "Sentiment_Score", label = scales::comma) +
  labs(title = "Real Talk Sample Sentiment in US") + 
  theme(panel.background = element_rect(colour = "black", fill = "white"), legend.position = "right")
```

```{r, fig.height= 15, fig.width= 7}
# EDA
par(mfrow = c(5,2))
hist(regdata$sentiment, breaks =20, main = "Histogram of sentiment score distribution")
plot(sentiment~Age, data = regdata, main = "sentiment ~ age")
plot(sentiment~Gender, data = regdata, main = "sentiment ~ gender")
plot(sentiment~LGBTQ., data = regdata, main = "sentiment ~ LGBT status")
plot(sentiment~Subject, data = regdata, main = "sentiment ~ different subjects")
plot(sentiment~Submission..Type, data = regdata, main = "sentiment ~ different submission types")
plot(sentiment~wordcount, data = regdata, main = "sentiment ~ word count of the story submitted")
boxplot(wordcount~sentiment2, data = regdata2, main = "categorical sentiment score ~ word count",
        xlab = "0 : sentimentscore <= 0,   1 : sentimentscore > 0", ylab = "wordcount")
boxplot(sentiment~Reg, data = regdata2, main = "sentiment ~ different region")
```

```{r}
ggplot(data = regdata2)+
  geom_point(aes(y = sentiment, x = LGBTQ.))+
  facet_wrap(~Reg)
```
```{r}
reg1 <- glm(sentiment2 ~ Age + Gender + LGBTQ. + Reg + wordcount + Submission..Type + Subject, family = binomial, data = regdata2)
reg2 <- glm(sentiment2 ~ Age + Gender + LGBTQ. + Reg + wordcount + Submission..Type + Subject + teen_preg_rate, family = binomial, data = regdata2)
reg3 <- glm(sentiment2 ~ Age + Gender + LGBTQ. + Reg + wordcount + Submission..Type + Subject + suicide_rate, family = binomial, data = regdata2)
reg4 <- glm(sentiment2 ~ Age + Gender + LGBTQ. + Reg + wordcount + Submission..Type + Subject + red, family = binomial, data = regdata2)
anova(reg1, reg2, test= "Chisq")
anova(reg1, reg3, test= "Chisq")
anova(reg1, reg4, test= "Chisq")
```


```{r}
reg5 <- glm(sentiment2 ~ Age + Gender + LGBTQ. * Reg + wordcount + Submission..Type + Subject, family = binomial, data = regdata2)
summary(reg5)
roc(regdata2$sentiment2, fitted(reg5), plot=T, legacy.axes=T)
binnedplot(x=regdata2$Age, y = regdata2$sentiment2 - fitted(reg5), xlab = "Age", ylab = "Residuals", main = "Binned residuals versus Age")
anova(reg1, reg5, test= "Chisq")
```

```{r}
reg6 <- lmer(sentiment ~ Age + Gender + LGBTQ. * Reg + wordcount + Submission..Type + Subject + (1 | Reg), data = regdata2) 
summary(reg6)
bwplot(Reg~resid(reg6), regdata2)
coef(reg6)
```




